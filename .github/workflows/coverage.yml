name: Full Stack Tests & Codecov

on:
  push:
    branches:
      - preprod
      - main
  pull_request:
    branches:
      - preprod
      - main

jobs:
  test-and-coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Backend Tests & Coverage
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          
      - name: Run Go Tests & Generate Coverage
        working-directory: ./backend
        run: go test -v -coverprofile=coverage.out ./...

      - name: Upload Go Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage.out
          flags: backend
          token: ${{ secrets.CODECOV_TOKEN }}
          
      # Frontend Tests & Coverage
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci
        
      - name: Run Vitest & Generate Coverage
        working-directory: ./frontend
        run: npx vitest run --coverage

      - name: Upload React Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./frontend/coverage/lcov.info
          flags: frontend
          token: ${{ secrets.CODECOV_TOKEN }}

